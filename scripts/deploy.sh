#!/bin/bash
# =============================================================================
# AWS EC2 ë°°í¬ ìŠ¤í¬ë¦½íŠ¸
# AI ê¸°ë°˜ ê°ì„± ì¼ê¸° ì•± - ë°±ì—”ë“œ ì„œë²„
# =============================================================================

set -e  # ì˜¤ë¥˜ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨

# ìƒ‰ìƒ ì •ì˜
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}ğŸš€ AI ê°ì„± ì¼ê¸° ì•± ë°°í¬ ì‹œì‘...${NC}"

# =============================================================================
# 1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸
# =============================================================================
echo -e "${YELLOW}ğŸ“‹ í™˜ê²½ ë³€ìˆ˜ í™•ì¸ ì¤‘...${NC}"

if [ ! -f .env ]; then
    echo -e "${RED}âŒ .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. .env.productionì„ ë³µì‚¬í•˜ì„¸ìš”.${NC}"
    exit 1
fi

# =============================================================================
# 2. Docker ì„¤ì¹˜ í™•ì¸
# =============================================================================
echo -e "${YELLOW}ğŸ³ Docker í™•ì¸ ì¤‘...${NC}"

if ! command -v docker &> /dev/null; then
    echo -e "${YELLOW}Dockerê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤...${NC}"
    sudo apt-get update
    sudo apt-get install -y docker.io docker-compose
    sudo systemctl start docker
    sudo systemctl enable docker
    sudo usermod -aG docker $USER
    echo -e "${GREEN}âœ… Docker ì„¤ì¹˜ ì™„ë£Œ${NC}"
fi

# =============================================================================
# 3. ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬
# =============================================================================
echo -e "${YELLOW}ğŸ§¹ ì´ì „ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ì¤‘...${NC}"

docker-compose -f docker-compose.prod.yml down --remove-orphans || true

# =============================================================================
# 4. Docker ì´ë¯¸ì§€ ë¹Œë“œ
# =============================================================================
echo -e "${YELLOW}ğŸ”¨ Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘...${NC}"

docker-compose -f docker-compose.prod.yml build --no-cache

# =============================================================================
# 5. ì»¨í…Œì´ë„ˆ ì‹œì‘
# =============================================================================
echo -e "${YELLOW}ğŸš€ ì»¨í…Œì´ë„ˆ ì‹œì‘ ì¤‘...${NC}"

docker-compose -f docker-compose.prod.yml up -d

# =============================================================================
# 6. í—¬ìŠ¤ì²´í¬
# =============================================================================
echo -e "${YELLOW}ğŸ¥ í—¬ìŠ¤ì²´í¬ ì¤‘...${NC}"

sleep 10  # ì»¨í…Œì´ë„ˆ ì‹œì‘ ëŒ€ê¸°

# ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í™•ì¸
if docker-compose -f docker-compose.prod.yml exec -T db pg_isready; then
    echo -e "${GREEN}âœ… PostgreSQL ì •ìƒ${NC}"
else
    echo -e "${RED}âŒ PostgreSQL ì—°ê²° ì‹¤íŒ¨${NC}"
    exit 1
fi

# Redis ì—°ê²° í™•ì¸
if docker-compose -f docker-compose.prod.yml exec -T redis redis-cli ping | grep -q "PONG"; then
    echo -e "${GREEN}âœ… Redis ì •ìƒ${NC}"
else
    echo -e "${RED}âŒ Redis ì—°ê²° ì‹¤íŒ¨${NC}"
    exit 1
fi

# =============================================================================
# 7. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
# =============================================================================
echo -e "${YELLOW}ğŸ“¦ ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì¤‘...${NC}"

docker-compose -f docker-compose.prod.yml exec -T web python manage.py migrate --noinput
docker-compose -f docker-compose.prod.yml exec -T web python manage.py collectstatic --noinput

# =============================================================================
# 8. ì •ë¦¬
# =============================================================================
echo -e "${YELLOW}ğŸ§¹ ë¶ˆí•„ìš”í•œ ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘...${NC}"

docker image prune -f

# =============================================================================
# ì™„ë£Œ
# =============================================================================
echo ""
echo -e "${GREEN}=============================================${NC}"
echo -e "${GREEN}âœ… ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!${NC}"
echo -e "${GREEN}=============================================${NC}"
echo ""
echo -e "ğŸŒ ì„œë²„ ìƒíƒœ í™•ì¸: ${YELLOW}docker-compose -f docker-compose.prod.yml ps${NC}"
echo -e "ğŸ“‹ ë¡œê·¸ í™•ì¸: ${YELLOW}docker-compose -f docker-compose.prod.yml logs -f${NC}"
echo ""

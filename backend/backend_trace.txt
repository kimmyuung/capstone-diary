============================= test session starts ==============================
platform linux -- Python 3.12.12, pytest-7.4.3, pluggy-1.6.0 -- /usr/local/bin/python
cachedir: .pytest_cache
django: version: 6.0.1, settings: config.settings (from ini)
rootdir: /app
configfile: pytest.ini
plugins: cov-4.1.0, Faker-20.1.0, django-4.7.0, anyio-4.12.1
collecting ... collected 14 items

diary/tests/test_views.py::DiaryAPITest::test_create_diary FAILED        [  7%]
diary/tests/test_views.py::DiaryAPITest::test_create_diary_triggers_reflection PASSED [ 14%]
diary/tests/test_views.py::DiaryAPITest::test_delete_diary PASSED        [ 21%]
diary/tests/test_views.py::DiaryAPITest::test_list_diaries PASSED        [ 28%]
diary/tests/test_views.py::DiaryAPITest::test_partial_update_diary PASSED [ 35%]
diary/tests/test_views.py::DiaryAPITest::test_retrieve_diary PASSED      [ 42%]
diary/tests/test_views.py::DiaryAPITest::test_update_diary PASSED        [ 50%]
diary/tests/test_views.py::DiaryAPITest::test_upload_voice_file PASSED   [ 57%]
diary/tests/test_views.py::DiaryPermissionTest::test_cannot_access_other_user_diary PASSED [ 64%]
diary/tests/test_views.py::DiaryPermissionTest::test_cannot_modify_other_user_diary PASSED [ 71%]
diary/tests/test_views.py::DiaryPermissionTest::test_unauthenticated_access PASSED [ 78%]
diary/tests/test_views.py::DiaryPermissionTest::test_user_only_sees_own_diaries PASSED [ 85%]
diary/tests/test_views.py::DiaryValidationTest::test_create_diary_with_empty_content PASSED [ 92%]
diary/tests/test_views.py::DiaryValidationTest::test_create_diary_without_title PASSED [100%]

=================================== FAILURES ===================================
________________________ DiaryAPITest.test_create_diary ________________________
diary/tests/test_views.py:45: in test_create_diary
    self.assertEqual(response.status_code, status.HTTP_201_CREATED)
E   AssertionError: 500 != 201
---------------------------- Captured stdout setup -----------------------------
Operations to perform:
  Synchronize unmigrated apps: corsheaders, drf_spectacular, messages, rest_framework, rest_framework_simplejwt, staticfiles
  Apply all migrations: admin, auth, contenttypes, diary, sessions
Synchronizing apps without migrations:
  Creating tables...
    Running deferred SQL...
Running migrations:
  Applying contenttypes.0001_initial... OK
  Applying auth.0001_initial... OK
  Applying admin.0001_initial... OK
  Applying admin.0002_logentry_remove_auto_add... OK
  Applying admin.0003_logentry_add_action_flag_choices... OK
  Applying contenttypes.0002_remove_content_type_name... OK
  Applying auth.0002_alter_permission_name_max_length... OK
  Applying auth.0003_alter_user_email_max_length... OK
  Applying auth.0004_alter_user_username_opts... OK
  Applying auth.0005_alter_user_last_login_null... OK
  Applying auth.0006_require_contenttypes_0002... OK
  Applying auth.0007_alter_validators_add_error_messages... OK
  Applying auth.0008_alter_user_username_max_length... OK
  Applying auth.0009_alter_user_last_name_max_length... OK
  Applying auth.0010_alter_group_name_max_length... OK
  Applying auth.0011_update_proxy_permissions... OK
  Applying auth.0012_alter_user_first_name_max_length... OK
  Applying diary.0001_initial... OK
  Applying diary.0002_diary_latitude_diary_location_name_diary_longitude_and_more... OK
  Applying diary.0003_add_push_token... OK
  Applying diary.0004_add_database_indexes... OK
  Applying diary.0005_tag_diarytag_userpreference_tag_tag_user_name_idx_and_more... OK
  Applying diary.0006_diarytemplate... OK
  Applying diary.0007_alter_userpreference_auto_emotion_analysis_and_more... OK
  Applying diary.0008_diary_reflection_answer_diary_reflection_question_and_more... OK
  Applying sessions.0001_initial... OK
---------------------------- Captured stderr setup -----------------------------
Creating test database for alias 'default' ('test_diary_db')...
----------------------------- Captured stderr call -----------------------------
DIARY_ENCRYPTION_KEY not set. Encryption disabled.
Updated embedding for diary 1
Emotion analysis failed: 429 You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits. To monitor your current usage, head to: https://ai.dev/rate-limit. 
* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 20, model: gemini-3-flash
Please retry in 18.364391097s. [links {
  description: "Learn more about Gemini API quotas"
  url: "https://ai.google.dev/gemini-api/docs/rate-limits"
}
, violations {
  quota_metric: "generativelanguage.googleapis.com/generate_content_free_tier_requests"
  quota_id: "GenerateRequestsPerDayPerProjectPerModel-FreeTier"
  quota_dimensions {
    key: "model"
    value: "gemini-3-flash"
  }
  quota_dimensions {
    key: "location"
    value: "global"
  }
  quota_value: 20
}
, retry_delay {
  seconds: 18
}
]
Updated embedding for diary 1
Failed to generate reflection question: Aggregate functions are not allowed in this query (reflection_question=<MagicMock name='mock.GenerativeModel().generate_content().text.strip().resolve_expression().resolve_expression()' id='124437222292704'>).
Unhandled exception: TransactionManagementError: An error occurred in the current transaction. You can't execute queries until the end of the 'atomic' block. | {'view': 'DiaryViewSet', 'method': 'POST', 'path': '/api/diaries/', 'user': 'testuser'}
------------------------------ Captured log call -------------------------------
WARNING  diary:encryption.py:33 DIARY_ENCRYPTION_KEY not set. Encryption disabled.
INFO     diary.services.chat_service:chat_service.py:38 Updated embedding for diary 1
ERROR    diary:emotion_service.py:129 Emotion analysis failed: 429 You exceeded your current quota, please check your plan and billing details. For more information on this error, head to: https://ai.google.dev/gemini-api/docs/rate-limits. To monitor your current usage, head to: https://ai.dev/rate-limit. 
* Quota exceeded for metric: generativelanguage.googleapis.com/generate_content_free_tier_requests, limit: 20, model: gemini-3-flash
Please retry in 18.364391097s. [links {
  description: "Learn more about Gemini API quotas"
  url: "https://ai.google.dev/gemini-api/docs/rate-limits"
}
, violations {
  quota_metric: "generativelanguage.googleapis.com/generate_content_free_tier_requests"
  quota_id: "GenerateRequestsPerDayPerProjectPerModel-FreeTier"
  quota_dimensions {
    key: "model"
    value: "gemini-3-flash"
  }
  quota_dimensions {
    key: "location"
    value: "global"
  }
  quota_value: 20
}
, retry_delay {
  seconds: 18
}
]
INFO     diary.services.chat_service:chat_service.py:38 Updated embedding for diary 1
ERROR    diary.views.diary_views:diary_views.py:240 Failed to generate reflection question: Aggregate functions are not allowed in this query (reflection_question=<MagicMock name='mock.GenerativeModel().generate_content().text.strip().resolve_expression().resolve_expression()' id='124437222292704'>).
ERROR    diary:exception_handler.py:90 Unhandled exception: TransactionManagementError: An error occurred in the current transaction. You can't execute queries until the end of the 'atomic' block. | {'view': 'DiaryViewSet', 'method': 'POST', 'path': '/api/diaries/', 'user': 'testuser'}
ERROR    django.request:log.py:249 Internal Server Error: /api/diaries/
=============================== warnings summary ===============================
../usr/local/lib/python3.12/site-packages/httplib2/auth.py:19
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:19: DeprecationWarning: 'setName' deprecated - use 'set_name'
    token = pp.Word(tchar).setName("token")

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:20
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:20: DeprecationWarning: 'leaveWhitespace' deprecated - use 'leave_whitespace'
    token68 = pp.Combine(pp.Word("-._~+/" + pp.nums + pp.alphas) + pp.Optional(pp.Word("=").leaveWhitespace())).setName(

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:20
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:20: DeprecationWarning: 'setName' deprecated - use 'set_name'
    token68 = pp.Combine(pp.Word("-._~+/" + pp.nums + pp.alphas) + pp.Optional(pp.Word("=").leaveWhitespace())).setName(

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:24
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:24: DeprecationWarning: 'setName' deprecated - use 'set_name'
    quoted_string = pp.dblQuotedString.copy().setName("quoted-string").setParseAction(unquote)

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:24
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:24: DeprecationWarning: 'setParseAction' deprecated - use 'set_parse_action'
    quoted_string = pp.dblQuotedString.copy().setName("quoted-string").setParseAction(unquote)

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:25
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:25: DeprecationWarning: 'setName' deprecated - use 'set_name'
    auth_param_name = token.copy().setName("auth-param-name").addParseAction(downcaseTokens)

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:25
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:25: DeprecationWarning: 'addParseAction' deprecated - use 'add_parse_action'
    auth_param_name = token.copy().setName("auth-param-name").addParseAction(downcaseTokens)

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:27
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:27: DeprecationWarning: 'delimitedList' deprecated - use 'DelimitedList'
    params = pp.Dict(pp.delimitedList(pp.Group(auth_param)))

../usr/local/lib/python3.12/site-packages/httplib2/auth.py:33
  /usr/local/lib/python3.12/site-packages/httplib2/auth.py:33: DeprecationWarning: 'delimitedList' deprecated - use 'DelimitedList'
    www_authenticate = pp.delimitedList(pp.Group(challenge))

diary/services/chat_service.py:1
  /app/diary/services/chat_service.py:1: FutureWarning: 
  
  All support for the `google.generativeai` package has ended. It will no longer be receiving 
  updates or bug fixes. Please switch to the `google.genai` package as soon as possible.
  See README for more details:
  
  https://github.com/google-gemini/deprecated-generative-ai-python/blob/main/README.md
  
    import google.generativeai as genai

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED diary/tests/test_views.py::DiaryAPITest::test_create_diary - Assertion...
================== 1 failed, 13 passed, 10 warnings in 9.78s ===================
